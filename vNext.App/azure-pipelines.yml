trigger:
- SPRINT
- TRY-RI-VNEXT-APP

pool:
  vmImage: ubuntu-latest

steps:

- task: NodeTool@0
  inputs:
    versionSpec: '14.17.4'
    
- task: Npm@1
  displayName: 'npm install'
  inputs:
    command: 'install'
    workingDir: '$(Build.SourcesDirectory)/vNext.App'
    
- task: gulp@0
  displayName: 'Build client'
  inputs:
    gulpFile: '$(Build.SourcesDirectory)/vNext.App/gulpfile.js'
    targets: 'build'
    gulpjs: '$(Build.SourcesDirectory)/vNext.App/node_modules/gulp/bin/gulp.js'

- task: Npm@1
  displayName: 'Next build'
  inputs:
    command: 'custom'
    workingDir: '$(Build.SourcesDirectory)/vNext.App'
    customCommand: 'run build'

- task: Npm@1
  displayName: 'Unit tests'
  inputs:
    command: 'custom'
    workingDir: '$(Build.SourcesDirectory)/vNext.App'
    customCommand: 'run test-js'

# - task: Npm@1
#   displayName: 'Browser tests'
#   inputs:
#     command: 'run test-automation'
#     workingDir: '$(Build.SourcesDirectory)'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'vNextApp'
    publishLocation: 'pipeline'

- task: PublishTestResults@2
  displayName: 'Publish Unit Test Results'
  inputs:
    testResultsFiles: 'jest-junit.xml'
    searchFolder: '$(System.DefaultWorkingDirectory)/vNext.App/test-reports/unit'
    testRunTitle: 'Unit Test Run'
  continueOnError: true

- task: PublishCodeCoverageResults@1
  displayName: 'Publish Code Coverage from Unit Tests'
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/vNext.App/test-reports/unit/cobertura-coverage.xml'
    failIfCoverageEmpty: true
