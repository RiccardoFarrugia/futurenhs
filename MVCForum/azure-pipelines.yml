trigger:
 branches:
    include:
    - SPRINT
 paths:
    include:
    - MVCForum/*

jobs:
- job: CheckChangesInPaths
  pool:
    vmImage: 'windows-latest'
  steps: 
  - powershell: |
      $url="$(System.CollectionUri)/$(System.TeamProject)/_apis/git/repositories/$(Build.Repository.ID)/commits/$(Build.SourceVersion)/changes?api-version=5.1"
      $result = Invoke-RestMethod -Uri $url -Headers @{Authorization = "Bearer $(System.AccessToken)"} -Method GET
                       
      $changesFolder  = $result.changes | Where-Object{$_.item.gitObjectType -match "tree"} | Select-Object -Property {$_.item.path}
     
      foreach($path in $changesFolder ){
        if($path -match '/MVCForum'){
          echo "##vso[task.setvariable variable=MVCForum;isOutput=true]$True"
          break
        }
      }
    name: ChangesInPaths

- job: BuildMVCForum
  pool :
    vmImage: 'windows-latest'
  dependsOn: CheckChangesInPaths
  condition: eq(dependencies.CheckChangesInPaths.outputs['ChangesInPaths.MVCForum'], 'true') 
  steps:
  - task: NuGetToolInstaller@1
    inputs:
     versionSpec:

  - task: NuGetCommand@2
    inputs:
     command: 'restore'
     restoreSolution: 'MVCForum/MVCForum.sln'
     feedsToUse: 'select'

  - task: NodeTool@0
    inputs:
     versionSpec: '12.22.1'
    
  - task: Cache@2
    displayName: npm Cache
    inputs:
     key: 'npmcache | "$(Agent.OS)" | $(Build.SourcesDirectory)/MVCForum/package.json'
     path: '$(Build.SourcesDirectory)/MVCForum/node_modules'
     cacheHitVar: 'npm_cache_hit'

  - task: Npm@1
    displayName: 'npm install'
    condition: ne(variables.npm_cache_hit, 'true')
    inputs:
     command: 'install'
     workingDir: '$(Build.SourcesDirectory)/MVCForum'
    
  - task: gulp@0
    displayName: 'Build front end'
    inputs:
     workingDirectory: '$(Build.SourcesDirectory)/MVCForum'
     gulpFile: '$(Build.SourcesDirectory)/MVCForum/gulpfile.js'
     targets: 'buildWeb'
     gulpjs: '$(Build.SourcesDirectory)/MVCForum/node_modules/gulp/bin/gulp.js'
     enableCodeCoverage: false

  - task: MSBuild@1
    inputs:
     solution: '$(Build.SourcesDirectory)/MVCForum/MVCForum.sln'
     msbuildArchitecture: 'x64'
     configuration: 'Release'
     createLogFile: true
     logFileVerbosity: 'diagnostic'

  - task: CopyFiles@2
    inputs:
     SourceFolder: '$(Build.SourcesDirectory)/MVCForum/MVCForum.Website'
     Contents: '**'
     TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishPipelineArtifact@1
    inputs:
     targetPath: '$(Build.ArtifactStagingDirectory)'
     artifact: 'FNHS'
     publishLocation: 'pipeline'

  - task: PublishTestResults@2
    displayName: 'Publish Front End Unit Test Results'
    inputs:
     testResultsFiles: 'jest-junit.xml'
     searchFolder: '$(System.DefaultWorkingDirectory)/js-report'
     testRunTitle: 'Front End Test Run'
    continueOnError: true

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Code Coverage from Front End Unit Tests'
    inputs:
     codeCoverageTool: Cobertura
     summaryFileLocation: '$(System.DefaultWorkingDirectory)/MVCForum/js-report/cobertura-coverage.xml'
     pathToSources: '$(System.DefaultWorkingDirectory)/MVCForum'
     reportDirectory: '$(System.DefaultWorkingDirectory)/MVCForum/js-report/*.htm'
     failIfCoverageEmpty: true
